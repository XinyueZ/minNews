<?xml version="1.0" encoding="UTF-8"?>
<project name="custom_rules">
	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="../lib/ant/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>
	<target name="build">
		<!--Tasks-->
		<property file="project.properties"/>
		<property name="target" value="${target} "/>
		<property name="android.library" value="${android.library} "/>
		<property name="android.library.reference.1" value="${android.library.reference.1} "/>
		<echo message="#######target: ${target}#######"/>
		<echo message="#######android.library: ${android.library}#######"/>
		<echo message="#######android.library.reference.1: ${android.library.reference.1}#######"/>
		<propertyset id="android.library.references">
			<propertyref prefix="android.library.reference."/>
		</propertyset>
		<for list="${android.library.references}" param="ref">
			<sequential>
				<echo message="#######Lib: @{ref}#######"/>
			</sequential>
		</for>

		<!--Replace all v4 library in library projects.-->
		<copy file="libs/android-support-v4.jar"
		      todir="libs/ActionBar/library/libs/"
		      overwrite="true"/>
		<copy file="libs/android-support-v4.jar"
		      todir="submodules/Android-ViewPagerIndicator/library/libs/"
		      overwrite="true"/>

		<!--Application specialized tasks-->
		<echo>#######Replacing location of ActionBar.#######</echo>
		<replaceregexp match="../../../your/path/to/actionbarsherlock"
		               replace='../../../../libs/ActionBar/library'>
			<fileset dir="submodules/ActionBar-PullToRefresh/extras/actionbarsherlock">
				<include name="project.properties"/>
			</fileset>
		</replaceregexp>

		<!--Make application-->
		<echo message="#######Building: ${job_name}#######"/>
		<echo message="#######Mode: ${mode}#######"/>
		<antcall target="clean"/>
		<antcall target="${mode}"/>

		<!--After building process.-->
		<echo>#######After building.#######</echo>
		<echo message="#######Build number: ${build_number}#######"/>

		<!--Find debug build-->
		<condition property="debug.present">
			<available file="bin/${job_name}-debug.apk"/>
		</condition>
		<antcall target="op.debug"/>

		<!--Find release build-->
		<condition property="release.present">
			<available file="bin/${job_name}-release.apk"/>
		</condition>
		<antcall target="op.release"/>

		<!--Reset-->
		<echo>#######Reset.#######</echo>
		<exec executable="git" dir=".">
			<arg value="reset"/>
			<arg value="--hard"/>
			<arg value="HEAD"/>
		</exec>
	</target>

	<target name="op.debug" if="debug.present">
		<echo>#######Find debug build.#######</echo>
		<echo message="#######Output: bin/${job_name}-debug.apk#######"/>
		<copy file="bin/${job_name}-debug.apk"
		      tofile="bin/${job_name}-${build_number}-debug.apk"
		      overwrite="true"/>
	</target>

	<target name="op.release" if="release.present">
		<echo>#######Find release build.#######</echo>
		<echo message="#######Output: bin/${job_name}-release.apk#######"/>
		<copy file="bin/${job_name}-release.apk"
		      tofile="bin/${job_name}-${build_number}-release.apk"
		      overwrite="true"/>
	</target>
</project>